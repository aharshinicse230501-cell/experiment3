pipeline {
  agent any
  environment {
    DOCKER_IMAGE = "aharshinicse230501-cell/experiment3"
  }
  stages {
    stage('Checkout') {
      steps {
        git 'https://github.com/aharshinicse230501-cell/experiment3.git'
      }
    }
    stage('Build Docker Image') {
      steps {
        sh "docker build -t $DOCKER_IMAGE:$BUILD_NUMBER ."
      }
    }
    stage('Push to DockerHub') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_PASS')]) {
          sh """
            echo \$DOCKERHUB_PASS | docker login -u \$DOCKERHUB_USER --password-stdin
            docker push $DOCKER_IMAGE:$BUILD_NUMBER
          """
        }
      }
    }
    stage('Deploy to Kubernetes') {
      steps {
        sh "kubectl set image deployment/myapp-deployment myapp=$DOCKER_IMAGE:$BUILD_NUMBER --record"
      }
    }
  }
}
